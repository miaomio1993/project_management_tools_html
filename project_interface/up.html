<html>
<head>
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap-select/1.12.4/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="../assets/bootstrap-wysihtml5/bootstrap-wysihtml5.css">
    <link rel="stylesheet" href="../assets/css/xenon-core.css">
    <link rel="stylesheet" href="../assets/css/xenon-forms.css">
    <link rel="stylesheet" href="../assets/css/xenon-components.css">
    <link rel="stylesheet" href="../assets/css/xenon-skins.css">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <script src="https://cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>
    <title>添加接口</title>
</head>

<body style="padding: 15px;">
<div class="panel panel-default">
    <div class="panel-heading">
        <div class="row">
            <div class="col-sm-9">
                <h3><i class="linecons-pencil"></i>INSERT / UPDATE / DELETE</h3>
            </div>
            <div class="col-sm-3 col-xs-8">
                <button id="up" type="submit"
                        class="btn btn-secondary btn-single btn-icon btn-icon-standalone btn-icon-standalone-right btn-block">
                    <i class="linecons-mail"></i>
                    <span>Submit</span>
                </button>
            </div>
        </div>
    </div>
    <div class="panel-body">
        <div class="form-group">
            <input id="projectInterfaceId" type="hidden">
            <div class="col-sm-2">
                <select id="projectId" class="selectpicker" data-live-search="true" data-size="8">
                </select>
            </div>
            <div class="col-sm-2">
                <select id="projectGroupId" class="selectpicker" data-live-search="true" data-size="8">
                </select>
            </div>
            <select id="type" class="selectpicker">
                <option value="1">POST</option>
                <option value="2">GET</option>
            </select>
            <select id="state" class="selectpicker">
                <option value="1">待开发</option>
                <option value="2">开发中</option>
                <option value="3">可对接</option>
                <option value="4">维护中</option>
                <option value="5">已弃用</option>
            </select>
        </div>
        <div class="form-group">
            <input id="url" class="form-control" type="text" placeholder="接口URL"/>
        </div>
        <div class="form-group">
            <input id="name" class="form-control" type="text" placeholder="接口名称"/>
        </div>
        <div class="form-group">
            <textarea id="desc" class="form-control wysihtml5"
                      data-stylesheet-url="assets/js/wysihtml5/lib/css/wysiwyg-color.css" placeholder="接口描述"></textarea>
        </div>
        <hr/>
        <div id="parameters">
        </div>
        <hr/>
        <div class="form-group">
            <textarea id="returnStructure" class="form-control" rows="20" placeholder="接口JSON返回值"/></textarea>
        </div>
    </div>
</div>

<!-- 参数模板 -->
<div class="hidden parameter">
    <div class="row">
        <div class="col-sm-3">
            <input id="parameterName" type="text" class="form-control" placeholder="参数名称"/>
        </div>
        <div class="col-sm-2">
            <select id="parameterDateType" class="form-control selectpicker">
                <option value="String">String</option>
                <option value="Integer">Integer</option>
                <option value="List">List</option>
                <option value="Json">Json</option>
            </select>
        </div>
        <div class="col-sm-5">
            <input id="parameterDesc" type="text" class="form-control" placeholder="参数注释"/>
        </div>
        <div class="col-sm-2">
            <button class="btn btn-icon btn-red delParameter">
                <i class="fa-remove"></i>
            </button>
            <button class="btn btn-icon btn-success addParameter">
                <i class="fa-check"></i>
            </button>
        </div>
    </div>
</div>

<!-- Bottom Scripts -->
<script src="https://cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap-select/1.12.4/js/bootstrap-select.min.js"></script>
<script src="https://cdn.bootcss.com/wysihtml5/0.3.0/wysihtml5.min.js"></script>
<script src="../assets/js/TweenMax.min.js"></script>
<script src="../assets/js/resizeable.js"></script>
<script src="../assets/js/xenon-toggles.js"></script>
<script src="../assets/bootstrap-wysihtml5/bootstrap-wysihtml5.js"></script>

<!-- JavaScripts initializations and stuff -->
<script src="../assets/js/xenon-custom.js"></script>
<script src="../assets/js/initialization.js"></script>

<script type="text/javascript">
    window.onload = function () {
        getProjectList();
        $("#projectId").val(getUrlParam("projectId"));
        $('#projectId').selectpicker('refresh');
        getProjectGroupList();
        $("#projectGroupId").val(getUrlParam("projectGroupId"));
        $('#projectGroupId').selectpicker('refresh');

        $("#projectInterfaceId").val(getUrlParam("projectInterfaceId"));
        $.ajax({
            type: 'post',
            url: url + "projectInterface/getInfo",
            async: false,
            data: {
                projectInterfaceId: $("#projectInterfaceId").val()
            },
            success: function (data) {
                if (data.code == 0) {
                    data = data.data;
                    $("#projectInterfaceId").val(data.id);
                    $("#type").val(data.type);
                    $("#state").val(data.state);
                    $("#url").val(data.url);
                    $("#name").val(data.name);
                    $("#desc").val(data.depict);
                    var parameters = JSON.parse(data.parameter);
                    for (let i = 0; i < parameters.length; i++) {
                        $("#parameters").append($(".parameter").html());
                        $("#parameters .row:first-of-type").find("#parameterName").val(parameters[i].name);
                        $("#parameters .row:first-of-type").find("#parameterDateType").val(parameters[i].dateType);
                        $("#parameters .row:first-of-type").find("#parameterDesc").val(parameters[i].desc);
                    }
                    $("#returnStructure").val(data.returnStructure);
                } else {
                    alert(data.msg);
                }
            }
        });
    };

    // 点击添加参数
    $(document).on("click", '.addParameter', function () {
        $("#parameters").append($(".parameter").html());

    });

    // 修改接口
    $("#up").click(function () {
        // 获取接口参数
        var parametersList = [];
        var parameter = {};
        var parameters = $("#parameters").children(".row").length;
        for (let i = 0; i < parameters; i++) {
            parameter.name = $("#parameters").find(".row").eq(i).find("#parameterName").val();
            parameter.dateType = $("#parameters").find(".row").eq(i).find("#parameterDateType").val();
            parameter.desc = $("#parameters").find(".row").eq(i).find("#parameterDesc").val();
            parametersList[i] = parameter;
        }
        var projectInterfaceId = $("#projectInterfaceId").val();
        var projectId = $("#projectId").val();
        var projectGroupId = $("#projectGroupId").val();
        var type = $("#type").val();
        var state = $("#state").val();
        var aUrl = $("#url").val();
        var name = $("#name").val();
        var desc = $("#desc").val();
        var returnStructure = $("#returnStructure").val();
        if (aUrl == null || aUrl == "") {
            alert("请输入项目地址");
            return;
        }
        if (name == null || name == "") {
            alert("请输入项目名称");
            return;
        }
        if (desc == null || desc == "") {
            alert("请输入项目描述");
            return;
        }
        $.ajax({
            type: 'post',
            url: url + "projectInterface/up",
            data: {
                projectInterfaceId:projectInterfaceId ,
                projectId: projectId,
                projectGroupId: projectGroupId,
                type: type,
                state: state,
                url: aUrl,
                name: name,
                desc: desc,
                parameter: JSON.stringify(parametersList),
                returnStructure: returnStructure
            },
            success: function (data) {
                alert(data.msg);
            }
        });
    });

    function getProjectList() {
        $.ajax({
            type: 'post',
            url: url + "project/getList",
            async: false,
            success: function (data) {
                if (data.code == 0) {
                    data = data.data;
                    $("#projectId").html("");
                    var str = "<option value='0'>请选择项目</option>";
                    for (var i = 0; i < data.length; i++) {
                        str += "<option value='" + data[i].id + "'>" + data[i].name + "</option>"
                    }
                    $("#projectId").html(str);
                    $('#projectId').selectpicker('refresh');
                } else {
                    alert(data.msg);
                }
            }
        });
    }

    function getProjectGroupList() {
        $.ajax({
            type: 'post',
            url: url + "projectGroup/getList",
            async: false,
            data: {
                projectId: $('#projectId').val()
            },
            success: function (data) {
                if (data.code == 0) {
                    data = data.data;
                    $("#projectGroupId").html("");
                    var str = "<option value='0'>请选择分类</option>";
                    for (var i = 0; i < data.length; i++) {
                        str += "<option value='" + data[i].id + "'>" + data[i].name + "</option>"
                    }
                    $("#projectGroupId").html(str);
                    $('#projectGroupId').selectpicker('refresh');
                } else {
                    alert(data.msg);
                }
            }
        });
    }
</script>
</body>
</html>
